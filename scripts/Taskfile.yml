version: '3'

vars:
  BLAZEGRAPH_ENDPOINT: http://blazegraph:8080/blazegraph/sparql

tasks:
  default:
    desc: Run all tasks
    cmds:
      - task: download-ontologies
      - task: ingest-ontologies
      - task: cleanup

  cleanup:
    desc: Some cleanup tasks
    vars:
      QUERY: 
        sh: cat /scripts/queries/cleanup.sparql
    cmds:
      - curl --silent -X POST {{.BLAZEGRAPH_ENDPOINT}} --data-urlencode 'update={{.QUERY}}'

  download-ontologies:
    desc: Downloads the ontologies from the web
    cmds:
      - task: _download-file
        vars:
          URL: https://raw.githubusercontent.com/swiss-art-research-net/aaao/d222508a578f36faf2713481b4e23d7f6ef35eff/Serialization/AAAo_v2.0.rdf
          FILE: /data/AAAo_V2.0.0.rdf
      - task: _download-file
        vars:
          URL: https://ontome.net/api/namespaces-rdfs.rdf?namespace=188
          FILE: /data/CIDOC_CRM_V7.1.3.rdf
      - task: _download-file
        vars:
          URL: https://ontome.net/api/namespaces-rdf-owl.rdf?namespace=211
          FILE: /data/CRMdig_V4.0.rdf
      - task: _download-file
        vars:
          URL: https://cidoc-crm.org/extensions/crmtex/rdfs/2.0/CRMtex_v2.0.rdf
          FILE: /data/CRMtex_V2.0.rdf
      - task: _download-file
        vars:
          URL: https://cidoc-crm.org/extensions/lrmoo/rdfs/1.0/LRMoo_v1.0.rdf
          FILE: /data/LRMoo_V1.0.rdf
      - task: _download-file
        vars:
          URL: https://ontome.net/api/namespaces-rdf-owl.rdf?namespace=314
          FILE: /data/CRMinf_V1.0.rdf

  ingest-ontologies:
    desc: Ingests the ontologies into individual named Graphs
    cmds:
      - task: _ingest-data-from-file
        vars:
          NAME: AAAo
          FILE: /data/AAAo_V2.0.0.rdf
          TYPE: application/rdf+xml
          GRAPH: https://ontology.swissartresearch.net/aaao/context
      - task: _ingest-data-from-file
        vars:
          NAME: CIDOC_CRM
          FILE: /data/CIDOC_CRM_V7.1.3.rdf
          TYPE: application/rdf+xml
          GRAPH: http://www.cidoc-crm.org/cidoc-crm/context
      - task: _ingest-data-from-file
        vars:
          NAME: CRMdig
          FILE: /data/CRMdig_V4.0.rdf
          TYPE: application/rdf+xml
          GRAPH: http://www.ics.forth.gr/isl/CRMdig/context
      - task: _ingest-data-from-file
        vars:
          NAME: CRMinf
          FILE: /data/CRMinf_V1.0.rdf
          TYPE: application/rdf+xml
          GRAPH: http://www.ics.forth.gr/isl/CRMinf/context
      - task: _ingest-data-from-file
        vars:
          NAME: CRMtex
          FILE: /data/CRMtex_V2.0.rdf
          TYPE: application/rdf+xml
          GRAPH: http://www.cidoc-crm.org/crmtex/context
      - task: _ingest-data-from-file
        vars:
          NAME: LRMoo
          FILE: /data/LRMoo_V1.0.rdf
          TYPE: application/rdf+xml
          GRAPH: http://iflastandards.info/ns/lrm/lrmoo/context
    
  _download-file:
    desc: Downloads a file from the web
    internal: true
    requires:
      vars: [URL, FILE]
    status:
      - test -f {{.FILE}}
    cmds:
      - echo "Downloading file from {{.URL}} to {{.FILE}}"
      - wget -q -O {{.FILE}} {{.URL}}
      - echo "Download complete"  
  
  _drop-graph:
    internal: true
    cmds:
      - curl --silent -X POST {{.BLAZEGRAPH_ENDPOINT}} --data-urlencode "update=DROP GRAPH <{{.GRAPH}}>" > /dev/null

  _ingest-data-from-file:
    internal: true
    vars:
      ENDPOINT: 
        sh: echo "{{if .ENDPOINT}}{{.ENDPOINT}}{{else}}{{.BLAZEGRAPH_ENDPOINT}}{{end}}"
    cmds:
      - echo "Ingest {{.NAME}}"
      - curl --silent -X POST {{.ENDPOINT}} --data-urlencode 'update={{if .GRAPH}}DROP GRAPH <{{.GRAPH}}>{{end}}'
      - curl -X POST -H 'Content-Type:{{.TYPE}}' --data-binary '@{{.FILE}}' {{.ENDPOINT}}{{if .GRAPH}}?context-uri={{.GRAPH}}{{end}}
